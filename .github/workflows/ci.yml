name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

jobs:
  publishability:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        crate:
          - rave-core
          - rave-cuda
          - rave-ffmpeg
          - rave-nvcodec
          - rave-pipeline
          - rave-tensorrt
          - rave-runtime-nvidia
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenSSL build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: Publish dry-run (metadata/package)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        run: cargo publish --dry-run --no-verify -p ${{ matrix.crate }}

      - name: Package file list
        run: cargo package --list -p ${{ matrix.crate }}

  docsrs-compat:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install OpenSSL build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: docs.rs-style checks (native crates)
        env:
          CARGO_TARGET_DIR: target-docsrs-check
          DOCS_RS: "1"
        run: |
          cargo check -p rave-ffmpeg --no-default-features
          cargo check -p rave-tensorrt --no-default-features
          cargo check -p rave-nvcodec
          cargo check -p rave-runtime-nvidia --no-default-features
          cargo check -p rave-pipeline --no-default-features

  checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install FFmpeg build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libavutil-dev \
            libavcodec-dev \
            libavformat-dev \
            libavfilter-dev \
            libavdevice-dev \
            libswscale-dev \
            libswresample-dev

      - name: Check crate boundaries
        run: ./scripts/check_deps.sh

      - name: Docs lint
        run: ./scripts/check_docs.sh

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Tests
        run: cargo test --workspace

      - name: Validate Harness (Best Effort)
        env:
          RAVE_MOCK_RUN: "1"
        run: cargo run -p rave-cli --features audit-no-host-copies --bin rave -- validate --json --best-effort --profile production_strict --fixture tests/fixtures/validate_production_strict.json
